<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleeper Defensive Matchup Analyzer - All 32 Teams</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IDP Analyzer">
    <meta name="msapplication-TileColor" content="#2c3e50">
    <meta name="description" content="Analyze NFL defensive player matchups and get waiver wire recommendations for fantasy football IDP leagues">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0f1419 0%, #1a1f26 100%); min-height: 100vh; padding: 20px; color: #e6e6e6; }
        .container { max-width: 1400px; margin: 0 auto; background: #1a1f26; border-radius: 15px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); overflow: hidden; border: 1px solid #2d3748; }
        .header { background: linear-gradient(135deg, #1a1f26 0%, #2d3748 100%); color: #e6e6e6; padding: 30px; text-align: center; border-bottom: 2px solid #00d4aa; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; color: #00d4aa; }
        .header p { color: #a0aec0; }
        .controls { padding: 30px; background: #2d3748; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-weight: 600; color: #e6e6e6; }
        .input-group input, .input-group select { padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 16px; min-width: 200px; background: #1a1f26; color: #e6e6e6; }
        .input-group input:focus, .input-group select:focus { border-color: #00d4aa; outline: none; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #00d4aa, #00b894); color: #1a1f26; transition: all 0.3s ease; }
        .btn:hover { background: linear-gradient(135deg, #00b894, #00d4aa); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn.waiver { background: linear-gradient(135deg, #00d4aa, #00b894); margin-top: 10px; }
        .btn.waiver:hover { background: linear-gradient(135deg, #00b894, #00d4aa); }
        .position-tabs { display: flex; background: #2d3748; margin: 0 30px; border-radius: 8px; overflow: hidden; flex-wrap: wrap; border: 1px solid #4a5568; }
        .position-tab { flex: 1; min-width: 140px; padding: 15px 10px; background: #2d3748; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s ease; color: #a0aec0; text-align: center; border-right: 1px solid #4a5568; }
        .position-tab:last-child { border-right: none; }
        .position-tab.active { background: linear-gradient(135deg, #00d4aa, #00b894); color: #1a1f26; }
        .position-tab:hover:not(.active) { background: #4a5568; color: #e6e6e6; }
        .status { padding: 20px 30px; text-align: center; font-size: 16px; font-weight: 500; background: #1a1f26; }
        .status.loading { color: #00d4aa; }
        .status.error { color: #f56565; background: #2d1b1b; border-left: 4px solid #f56565; }
        .status.success { color: #00d4aa; background: #1a2e25; border-left: 4px solid #00d4aa; }
        .results-section { padding: 30px; background: #1a1f26; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #2d3748, #4a5568); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 1px solid #4a5568; }
        .summary-card h3 { color: #a0aec0; font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; }
        .summary-card .value { font-size: 2rem; font-weight: 700; color: #00d4aa; }
        .table-container { background: #2d3748; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 1px solid #4a5568; }
        table { width: 100%; border-collapse: collapse; }
        th { background: linear-gradient(135deg, #1a1f26, #2d3748); color: #00d4aa; padding: 16px 12px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; border-bottom: 2px solid #00d4aa; }
        td { padding: 14px 12px; border-bottom: 1px solid #4a5568; color: #e6e6e6; }
        tr:hover { background-color: #374151; }
        .rank { font-weight: 700; text-align: center; min-width: 50px; }
        .team-name { font-weight: 600; color: #e6e6e6; }
        .points { font-weight: 700; text-align: center; }
        .rank-1-8 { background-color: rgba(72, 187, 120, 0.2) !important; border-left: 4px solid #48bb78; }
        .rank-9-16 { background-color: rgba(251, 211, 141, 0.2) !important; border-left: 4px solid #ed8936; } 
        .rank-17-24 { background-color: rgba(237, 137, 54, 0.2) !important; border-left: 4px solid #fbd38d; } 
        .rank-25-32 { background-color: rgba(245, 101, 101, 0.2) !important; border-left: 4px solid #f56565; }
        .legend { display: flex; gap: 20px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 500; color: #e6e6e6; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #4a5568; }
        .legend .rank-1-8 .legend-color { background-color: #48bb78; }
        .legend .rank-9-16 .legend-color { background-color: #ed8936; }
        .legend .rank-17-24 .legend-color { background-color: #fbd38d; }
        .legend .rank-25-32 .legend-color { background-color: #f56565; }
        .waiver-section { margin-top: 40px; padding: 25px; background: linear-gradient(135deg, #2d3748, #1a1f26); border-radius: 12px; border: 2px solid #00d4aa; }
        .waiver-header { text-align: center; margin-bottom: 20px; }
        .waiver-header h2 { color: #00d4aa; font-size: 1.8rem; margin-bottom: 10px; }
        .waiver-header p { color: #a0aec0; }
        .waiver-recommendations { display: flex; flex-direction: column; gap: 20px; }
        .waiver-recommendations { display: flex; flex-direction: column; gap: 20px; }
        .waiver-top-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .waiver-bottom-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .waiver-card { background: #2d3748; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 2px solid #00d4aa; text-align: center; }
        .waiver-card h3 { color: #00d4aa; font-size: 1.2rem; margin-bottom: 10px; }
        .waiver-card .player-name { font-size: 1.1rem; font-weight: 600; color: #e6e6e6; margin-bottom: 5px; }
        .waiver-card .matchup { color: #a0aec0; margin-bottom: 5px; }
        .waiver-card .points { color: #e6e6e6; font-weight: 600; }
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .position-tabs { margin: 0 15px; }
            .position-tab { font-size: 0.8rem; padding: 12px 8px; min-width: 100px; }
            .results-section { padding: 20px 15px; }
            .waiver-recommendations { grid-template-columns: 1fr; }
            .waiver-card:nth-child(4), .waiver-card:nth-child(5) { grid-column: 1; margin: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NFL Offensive Teams Allowing Points to Defense</h1>
            <p>Ranking ALL 32 NFL OFFENSIVE teams by fantasy points they ALLOW to defensive players (including dual threat analysis)</p>
        </div>

        <div class="controls">
            <div class="input-group">
                <label for="leagueId">Sleeper League ID: <span style="color: red;">*</span></label>
                <input type="text" id="leagueId" placeholder="Required - Enter your League ID" required>
            </div>
            <div class="input-group">
                <label for="season">Season:</label>
                <select id="season">
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>
            <div class="input-group">
                <label for="maxWeek">Through Week:</label>
                <select id="maxWeek">
                    <option value="1">Week 1</option>
                    <option value="2" selected>Week 2</option>
                    <option value="3">Week 3</option>
                    <option value="4">Week 4</option>
                    <option value="5">Week 5</option>
                    <option value="6">Week 6</option>
                    <option value="7">Week 7</option>
                    <option value="8">Week 8</option>
                    <option value="9">Week 9</option>
                    <option value="10">Week 10</option>
                    <option value="11">Week 11</option>
                    <option value="12">Week 12</option>
                    <option value="13">Week 13</option>
                    <option value="14">Week 14</option>
                    <option value="15">Week 15</option>
                    <option value="16">Week 16</option>
                    <option value="17">Week 17</option>
                    <option value="18">Week 18</option>
                </select>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="analyzeBtn" class="btn">Analyze All 32 Teams</button>
                <button id="waiverBtn" class="btn waiver" style="display: none;">Get Waiver Recommendations</button>
            </div>
        </div>

        <div class="position-tabs" style="display: none;" id="positionTabs">
            <button class="position-tab active" onclick="showPosition('DL')" data-position="DL">
                Defensive Line (DL)
            </button>
            <button class="position-tab" onclick="showPosition('LB')" data-position="LB">
                Linebackers (LB)
            </button>
            <button class="position-tab" onclick="showPosition('DB')" data-position="DB">
                Defensive Backs (DB)
            </button>
            <button class="position-tab" onclick="showPosition('DL/LB')" data-position="DL/LB">
                DL/LB Dual
            </button>
            <button class="position-tab" onclick="showPosition('LB/DB')" data-position="LB/DB">
                LB/DB Dual
            </button>
        </div>

        <div id="status" class="status">Enter your Sleeper League ID to analyze all 32 teams</div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <div class="legend">
                <div class="legend-item rank-1-8">
                    <div class="legend-color"></div>
                    <span>1-8 (WORST Offenses - Allow Most Points)</span>
                </div>
                <div class="legend-item rank-9-16">
                    <div class="legend-color"></div>
                    <span>9-16</span>
                </div>
                <div class="legend-item rank-17-24">
                    <div class="legend-color"></div>
                    <span>17-24</span>
                </div>
                <div class="legend-item rank-25-32">
                    <div class="legend-color"></div>
                    <span>25-32 (BEST Offenses - Allow Fewest Points)</span>
                </div>
            </div>

            <div class="summary-cards" id="summaryCards"></div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Offensive Team</th>
                            <th>Points ALLOWED to Defense</th>
                            <th>Avg Per Game</th>
                            <th>Games Played</th>
                            <th>Best Single Game (Most Allowed)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="waiverSection" class="waiver-section" style="display: none;">
                <div class="waiver-header">
                    <h2>Waiver Wire Recommendations</h2>
                    <p>Top available players with favorable matchups for next week</p>
                </div>
                <div id="waiverRecommendations" class="waiver-recommendations">
                </div>
            </div>
        </div>
    </div>

    <script>
        class SleeperIDPAnalyzer {
            constructor() {
                this.players = {};
                this.scoringSettings = null;
                this.nflSchedule = {};
                this.leagueRosters = [];
                this.playerStats = {};
                this.setupEventListeners();

                this.results = {
                    DL: {},
                    LB: {},
                    DB: {},
                    'DL/LB': {},
                    'LB/DB': {}
                };

                this.teamMappings = {
                    'ARI': 'Arizona Cardinals', 'ATL': 'Atlanta Falcons', 'BAL': 'Baltimore Ravens',
                    'BUF': 'Buffalo Bills', 'CAR': 'Carolina Panthers', 'CHI': 'Chicago Bears',
                    'CIN': 'Cincinnati Bengals', 'CLE': 'Cleveland Browns', 'DAL': 'Dallas Cowboys',
                    'DEN': 'Denver Broncos', 'DET': 'Detroit Lions', 'GB': 'Green Bay Packers',
                    'HOU': 'Houston Texans', 'IND': 'Indianapolis Colts', 'JAX': 'Jacksonville Jaguars',
                    'KC': 'Kansas City Chiefs', 'LV': 'Las Vegas Raiders', 'LAC': 'Los Angeles Chargers',
                    'LAR': 'Los Angeles Rams', 'MIA': 'Miami Dolphins', 'MIN': 'Minnesota Vikings',
                    'NE': 'New England Patriots', 'NO': 'New Orleans Saints', 'NYG': 'New York Giants',
                    'NYJ': 'New York Jets', 'PHI': 'Philadelphia Eagles', 'PIT': 'Pittsburgh Steelers',
                    'SF': 'San Francisco 49ers', 'SEA': 'Seattle Seahawks', 'TB': 'Tampa Bay Buccaneers',
                    'TEN': 'Tennessee Titans', 'WAS': 'Washington Commanders'
                };

                this.espnTeamMap = {
                    'ARI': 'ARI', 'ATL': 'ATL', 'BAL': 'BAL', 'BUF': 'BUF', 'CAR': 'CAR', 'CHI': 'CHI',
                    'CIN': 'CIN', 'CLE': 'CLE', 'DAL': 'DAL', 'DEN': 'DEN', 'DET': 'DET', 'GB': 'GB',
                    'HOU': 'HOU', 'IND': 'IND', 'JAX': 'JAX', 'KC': 'KC', 'LV': 'LV', 'LAC': 'LAC',
                    'LAR': 'LAR', 'MIA': 'MIA', 'MIN': 'MIN', 'NE': 'NE', 'NO': 'NO', 'NYG': 'NYG',
                    'NYJ': 'NYJ', 'PHI': 'PHI', 'PIT': 'PIT', 'SF': 'SF', 'SEA': 'SEA', 'TB': 'TB',
                    'TEN': 'TEN', 'WSH': 'WAS', 'LA': 'LAR', 'WAS': 'WAS' 
                };
            }

            setupEventListeners() {
                document.getElementById('analyzeBtn').addEventListener('click', () => {
                    const leagueId = document.getElementById('leagueId').value.trim();
                    if (!leagueId) {
                        this.showStatus('Please enter your Sleeper League ID first.', 'error');
                        return;
                    }
                    this.analyzeDefensiveMatchups();
                });

                document.getElementById('waiverBtn').addEventListener('click', () => {
                    this.getWaiverRecommendations();
                });
            }

            showStatus(message, type = 'loading') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }

            async fetchData(url) {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            }

            async analyzeDefensiveMatchups() {
                try {
                    const analyzeBtn = document.getElementById('analyzeBtn');
                    analyzeBtn.disabled = true;

                    const leagueId = document.getElementById('leagueId').value.trim();
                    const season = document.getElementById('season').value;
                    const maxWeek = parseInt(document.getElementById('maxWeek').value);

                    this.showStatus('Loading league settings...', 'loading');
                    
                    const leagueData = await this.fetchData(`https://api.sleeper.app/v1/league/${leagueId}`);
                    this.scoringSettings = leagueData.scoring_settings || {};
                    
                    const idpCategories = Object.keys(this.scoringSettings).filter(key => 
                        key.startsWith('idp_') && this.scoringSettings[key] !== 0
                    );
                    
                    if (idpCategories.length === 0) {
                        throw new Error('No IDP scoring found in this league.');
                    }

                    this.showStatus('Loading NFL players...', 'loading');
                    this.players = await this.fetchData('https://api.sleeper.app/v1/players/nfl');

                    this.showStatus('Loading league rosters...', 'loading');
                    this.leagueRosters = await this.fetchData(`https://api.sleeper.app/v1/league/${leagueId}/rosters`);

                    this.showStatus('Loading NFL schedules...', 'loading');
                    await this.loadNFLSchedule(season, maxWeek);

                    this.results = { DL: {}, LB: {}, DB: {}, 'DL/LB': {}, 'LB/DB': {} };
                    this.playerStats = {};
                    this.initializeResults();

                    let totalRealPlayers = 0;

                    for (let week = 1; week <= maxWeek; week++) {
                        this.showStatus(`Processing Week ${week}...`, 'loading');
                        const weekRealPlayers = await this.processWeekData(season, week);
                        totalRealPlayers += weekRealPlayers;
                        await new Promise(resolve => setTimeout(resolve, 300)); 
                    }

                    if (totalRealPlayers === 0) {
                        throw new Error(`No defensive players found. Check your league settings.`);
                    }

                    this.showStatus('Analysis complete!', 'success');
                    document.getElementById('positionTabs').style.display = 'flex';
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('waiverBtn').style.display = 'block';
                    this.showPosition('DL');

                } catch (error) {
                    this.showStatus(error.message, 'error');
                    document.getElementById('positionTabs').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'none';
                } finally {
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }

            async loadNFLSchedule(season, maxWeek) {
                this.nflSchedule = {};
                
                for (let week = 1; week <= maxWeek + 1; week++) { // Load next week too for waivers
                    try {
                        const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?seasontype=2&week=${week}&year=${season}`;
                        const data = await this.fetchData(url);
                        
                        if (!data.events || data.events.length === 0) continue;

                        this.nflSchedule[week] = {};
                        data.events.forEach(game => {
                            if (game.competitions?.[0]?.competitors?.length === 2) {
                                const competitors = game.competitions[0].competitors;
                                const team1 = this.normalizeTeam(competitors[0].team.abbreviation);
                                const team2 = this.normalizeTeam(competitors[1].team.abbreviation);

                                this.nflSchedule[week][team1] = team2;
                                this.nflSchedule[week][team2] = team1;
                            }
                        });
                        
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                    } catch (error) {
                        // Continue if schedule loading fails for a week
                    }
                }
            }

            normalizeTeam(abbr) {
                return this.espnTeamMap[abbr] || abbr; 
            }

            getDualThreatCategory(positions) {
                if (positions.length <= 1) return null;
                
                // Sort positions in specific order: DL, LB, DB
                const positionOrder = { 'DL': 1, 'LB': 2, 'DB': 3 };
                const sortedPositions = [...positions].sort((a, b) => positionOrder[a] - positionOrder[b]);
                return sortedPositions.join('/');
            }

            initializeResults() {
                ['DL', 'LB', 'DB', 'DL/LB', 'LB/DB'].forEach(position => {
                    this.results[position] = {};
                    Object.keys(this.teamMappings).forEach(team => {
                        this.results[position][team] = {
                            name: this.teamMappings[team],
                            pointsAllowed: 0,
                            gamesPlayed: 0,
                            bestSingleGame: 0,
                            weeklyBreakdown: []
                        };
                    });
                });
            }

            async processWeekData(season, week) {
                const weekSchedule = this.nflSchedule[week];
                if (!weekSchedule || Object.keys(weekSchedule).length === 0) {
                    return 0;
                }

                const weeklyTotals = { 
                    DL: new Map(), 
                    LB: new Map(), 
                    DB: new Map(),
                    'DL/LB': new Map(),
                    'LB/DB': new Map()
                };
                
                Object.keys(this.teamMappings).forEach(team => {
                    weeklyTotals.DL.set(team, 0);
                    weeklyTotals.LB.set(team, 0);
                    weeklyTotals.DB.set(team, 0);
                    weeklyTotals['DL/LB'].set(team, 0);
                    weeklyTotals['LB/DB'].set(team, 0);
                });

                let weekStats = null;
                try {
                    const url = `https://api.sleeper.app/v1/stats/nfl/regular/${season}/${week}`;
                    weekStats = await this.fetchData(url);
                    
                    if (!weekStats || Object.keys(weekStats).length === 0) {
                        return 0;
                    }
                } catch (error) {
                    return 0;
                }

                let scoringCount = 0;

                Object.entries(weekStats).forEach(([playerId, stats]) => {
                    if (!stats || typeof stats !== 'object') return;
                    
                    const hasRealStats = Object.keys(stats).some(key => 
                        key.startsWith('idp_') || 
                        ['tkl_solo', 'tkl_ast', 'sck', 'int', 'ff', 'fum_rec', 'pass_def', 'qb_hit'].includes(key)
                    );
                    
                    if (!hasRealStats) return;
                    
                    const masterPlayer = this.players[playerId];
                    if (!masterPlayer || !masterPlayer.team) return;

                    const fantasyPoints = this.calculateFantasyPoints(stats);
                    const defensivePositions = this.getDefensivePositions(masterPlayer); 
                    
                    if (defensivePositions.length === 0 || fantasyPoints <= 0) return;
                    
                    // Store player stats for waiver recommendations
                    if (!this.playerStats[playerId]) {
                        this.playerStats[playerId] = {
                            player: masterPlayer,
                            totalPoints: 0,
                            positions: defensivePositions,
                            dualThreatCategory: this.getDualThreatCategory(defensivePositions)
                        };
                    }
                    this.playerStats[playerId].totalPoints += fantasyPoints;
                    
                    scoringCount++;

                    const defenseTeam = this.normalizeTeam(masterPlayer.team);
                    const offenseTeam = weekSchedule[defenseTeam];

                    if (!offenseTeam || !this.results.DL[offenseTeam]) return;

                    defensivePositions.forEach(position => {
                        const currentTotal = weeklyTotals[position].get(offenseTeam) || 0;
                        weeklyTotals[position].set(offenseTeam, currentTotal + fantasyPoints);
                    });

                    // Handle dual threat players
                    const dualThreatCategory = this.getDualThreatCategory(defensivePositions);
                    if (dualThreatCategory && weeklyTotals[dualThreatCategory]) {
                        const currentDualTotal = weeklyTotals[dualThreatCategory].get(offenseTeam) || 0;
                        weeklyTotals[dualThreatCategory].set(offenseTeam, currentDualTotal + fantasyPoints);
                    }
                });

                if (scoringCount === 0) return 0;

                Object.keys(this.teamMappings).forEach(offenseTeam => {
                    const hasPoints = ['DL', 'LB', 'DB', 'DL/LB', 'LB/DB'].some(pos => 
                        weeklyTotals[pos].get(offenseTeam) > 0
                    );
                    
                    if (hasPoints) {
                        ['DL', 'LB', 'DB', 'DL/LB', 'LB/DB'].forEach(position => {
                            const weekPoints = weeklyTotals[position].get(offenseTeam) || 0;
                            
                            this.results[position][offenseTeam].pointsAllowed += weekPoints;
                            this.results[position][offenseTeam].weeklyBreakdown.push(weekPoints);
                            
                            if (weekPoints > this.results[position][offenseTeam].bestSingleGame) {
                                this.results[position][offenseTeam].bestSingleGame = weekPoints;
                            }
                        });
                        
                        // Only increment games played once per team (use DL as reference)
                        this.results['DL'][offenseTeam].gamesPlayed++;
                        // Copy games played to all other categories for consistency
                        ['LB', 'DB', 'DL/LB', 'LB/DB'].forEach(position => {
                            this.results[position][offenseTeam].gamesPlayed = this.results['DL'][offenseTeam].gamesPlayed;
                        });
                    }
                });
                
                return scoringCount;
            }

            calculateFantasyPoints(stats) {
                if (!stats || !this.scoringSettings) return 0;

                let points = 0;
                
                Object.keys(stats).forEach(statKey => {
                    if (this.scoringSettings[statKey] && statKey.startsWith('idp_')) {
                        const multiplier = this.scoringSettings[statKey];
                        const statValue = stats[statKey];
                        
                        if (statValue && statValue > 0) {
                            points += statValue * multiplier;
                        }
                    }
                });

                return Math.round(points * 100) / 100;
            }

            getDefensivePositions(player) {
                const fantasyPositions = player.fantasy_positions || [];

                // Use exactly what Sleeper says in fantasy_positions
                const eligiblePositions = [];
                
                // Check each fantasy position individually
                fantasyPositions.forEach(pos => {
                    if (pos === 'DL' || pos === 'DE' || pos === 'DT') {
                        if (!eligiblePositions.includes('DL')) {
                            eligiblePositions.push('DL');
                        }
                    } else if (pos === 'LB') {
                        if (!eligiblePositions.includes('LB')) {
                            eligiblePositions.push('LB');
                        }
                    } else if (pos === 'DB') {
                        if (!eligiblePositions.includes('DB')) {
                            eligiblePositions.push('DB');
                        }
                    }
                });
                
                // If no fantasy positions, fall back to NFL position
                if (eligiblePositions.length === 0) {
                    const nflPos = (player.position || '').toUpperCase().trim();
                    if (['DE', 'DT', 'NT'].includes(nflPos)) eligiblePositions.push('DL');
                    else if (['LB', 'OLB', 'ILB', 'MLB', 'ROLB', 'LOLB'].includes(nflPos)) eligiblePositions.push('LB');
                    else if (['CB', 'S', 'FS', 'SS', 'DB', 'SAF', 'NB'].includes(nflPos)) eligiblePositions.push('DB');
                }
                
                return eligiblePositions;
            }

            async getWaiverRecommendations() {
                try {
                    this.showStatus('Finding waiver recommendations...', 'loading');
                    
                    const currentWeek = parseInt(document.getElementById('maxWeek').value);
                    const nextWeek = currentWeek + 1;
                    const nextWeekSchedule = this.nflSchedule[nextWeek];
                    
                    if (!nextWeekSchedule) {
                        throw new Error(`No schedule found for Week ${nextWeek}`);
                    }

                    // Get rostered players
                    const rosteredPlayers = new Set();
                    this.leagueRosters.forEach(roster => {
                        if (roster.players) {
                            roster.players.forEach(playerId => rosteredPlayers.add(playerId));
                        }
                    });

                    const recommendations = {};
                    
                    ['DL', 'LB', 'DB', 'DL/LB', 'LB/DB'].forEach(position => {
                        // Get worst 8 offenses for this position (allow most points)
                        const worstOffenses = Object.entries(this.results[position])
                            .sort((a, b) => b[1].pointsAllowed - a[1].pointsAllowed)
                            .slice(0, 8)
                            .map(entry => entry[0]);

                        // Find defensive teams playing against these bad offenses next week
                        const favorableDefenses = [];
                        Object.entries(nextWeekSchedule).forEach(([defenseTeam, offenseTeam]) => {
                            if (worstOffenses.includes(offenseTeam)) {
                                favorableDefenses.push(defenseTeam);
                            }
                        });

                        // Find available players from these defenses for this position
                        const availablePlayers = [];
                        Object.entries(this.playerStats).forEach(([playerId, playerData]) => {
                            if (rosteredPlayers.has(playerId)) return;
                            
                            // Check if player matches the position category
                            let positionMatch = false;
                            if (['DL', 'LB', 'DB'].includes(position)) {
                                positionMatch = playerData.positions.includes(position);
                            } else {
                                // For dual threat categories, check if player has exactly those positions
                                const playerDualCategory = this.getDualThreatCategory(playerData.positions);
                                positionMatch = playerDualCategory === position;
                            }
                            
                            if (!positionMatch) return;
                            
                            const playerTeam = this.normalizeTeam(playerData.player.team);
                            if (!favorableDefenses.includes(playerTeam)) return;
                            
                            const opponent = nextWeekSchedule[playerTeam];
                            const avgAllowed = this.results[position][opponent]?.pointsAllowed / this.results[position][opponent]?.gamesPlayed || 0;
                            
                            availablePlayers.push({
                                playerId,
                                player: playerData.player,
                                totalPoints: playerData.totalPoints,
                                team: playerTeam,
                                opponent,
                                avgAllowed
                            });
                        });

                        // Get top scorer for this position
                        availablePlayers.sort((a, b) => b.totalPoints - a.totalPoints);
                        if (availablePlayers.length > 0) {
                            recommendations[position] = availablePlayers[0];
                        }
                    });

                    this.displayWaiverRecommendations(recommendations, nextWeek);
                    document.getElementById('waiverSection').style.display = 'block';
                    this.showStatus('Waiver recommendations ready!', 'success');

                } catch (error) {
                    this.showStatus(`Error: ${error.message}`, 'error');
                }
            }

            displayWaiverRecommendations(recommendations, nextWeek) {
                const container = document.getElementById('waiverRecommendations');
                container.innerHTML = '';

                // Create top row container for DL, LB, DB
                const topRow = document.createElement('div');
                topRow.className = 'waiver-top-row';
                
                ['DL', 'LB', 'DB'].forEach(position => {
                    const rec = recommendations[position];
                    const card = document.createElement('div');
                    card.className = 'waiver-card';
                    
                    if (!rec) {
                        card.innerHTML = `
                            <h3>${position}</h3>
                            <p>No favorable matchups found</p>
                        `;
                    } else {
                        const playerName = `${rec.player.first_name || ''} ${rec.player.last_name || ''}`.trim();
                        card.innerHTML = `
                            <h3>${position} Recommendation</h3>
                            <div class="player-name">${playerName}</div>
                            <div class="matchup">${rec.team} vs ${rec.opponent} (Week ${nextWeek})</div>
                            <div class="points">Season Total: ${rec.totalPoints.toFixed(1)} pts</div>
                            <div class="points">Opponent Avg Allowed: ${rec.avgAllowed.toFixed(1)} pts/game</div>
                        `;
                    }
                    topRow.appendChild(card);
                });

                // Create bottom row container for DL/LB, LB/DB
                const bottomRow = document.createElement('div');
                bottomRow.className = 'waiver-bottom-row';
                
                ['DL/LB', 'LB/DB'].forEach(position => {
                    const rec = recommendations[position];
                    const card = document.createElement('div');
                    card.className = 'waiver-card';
                    
                    if (!rec) {
                        card.innerHTML = `
                            <h3>${position}</h3>
                            <p>No favorable matchups found</p>
                        `;
                    } else {
                        const playerName = `${rec.player.first_name || ''} ${rec.player.last_name || ''}`.trim();
                        card.innerHTML = `
                            <h3>${position} Recommendation</h3>
                            <div class="player-name">${playerName}</div>
                            <div class="matchup">${rec.team} vs ${rec.opponent} (Week ${nextWeek})</div>
                            <div class="points">Season Total: ${rec.totalPoints.toFixed(1)} pts</div>
                            <div class="points">Opponent Avg Allowed: ${rec.avgAllowed.toFixed(1)} pts/game</div>
                        `;
                    }
                    bottomRow.appendChild(card);
                });

                container.appendChild(topRow);
                container.appendChild(bottomRow);
            }

            showPosition(position) {
                document.querySelectorAll('.position-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.position === position) {
                        tab.classList.add('active');
                    }
                });

                this.displayResults(this.results[position], position);
            }

            displayResults(data, position) {
                const sortedTeams = Object.entries(data)
                    .map(([abbr, stats]) => ({ abbr, ...stats }))
                    .sort((a, b) => b.pointsAllowed - a.pointsAllowed); 

                const totalPoints = sortedTeams.reduce((sum, team) => sum + team.pointsAllowed, 0);
                const maxWeek = parseInt(document.getElementById('maxWeek').value);

                document.getElementById('summaryCards').innerHTML = `
                    <div class="summary-card">
                        <h3>Position</h3>
                        <div class="value">${position}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Weeks Analyzed</h3>
                        <div class="value">${maxWeek}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Points Allowed</h3>
                        <div class="value">${totalPoints.toFixed(1)}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Teams Analyzed</h3>
                        <div class="value">32</div>
                    </div>
                `;

                const tableBody = document.getElementById('resultsTableBody');
                tableBody.innerHTML = '';

                sortedTeams.forEach((team, index) => {
                    const rank = index + 1;
                    const avgPerGame = team.gamesPlayed > 0 ? (team.pointsAllowed / team.gamesPlayed).toFixed(1) : '0.0';

                    let colorClass = '';
                    if (rank <= 8) colorClass = 'rank-1-8';
                    else if (rank <= 16) colorClass = 'rank-9-16';
                    else if (rank <= 24) colorClass = 'rank-17-24';
                    else colorClass = 'rank-25-32';

                    const row = document.createElement('tr');
                    row.className = colorClass;
                    row.innerHTML = `
                        <td class="rank">${rank}</td>
                        <td class="team-name">${team.abbr} - ${team.name}</td>
                        <td class="points">${team.pointsAllowed.toFixed(1)}</td>
                        <td class="points">${avgPerGame}</td>
                        <td class="points">${team.gamesPlayed}</td>
                        <td class="points">${team.bestSingleGame.toFixed(1)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.analyzer = new SleeperIDPAnalyzer();
        });

        function showPosition(position) {
            window.analyzer.showPosition(position);
        }
    </script>
</body>
</html>
